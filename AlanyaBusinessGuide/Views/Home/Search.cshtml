@model IEnumerable<AlanyaBusinessGuide.Models.Business>
@{
    ViewData["Title"] = "Alanya İşletmeleri";
    var query = ViewBag.Query as string ?? "";
    var category = ViewBag.Category as string;
    var categories = ViewBag.Categories as List<string> ?? new List<string>();
    var sortBy = ViewBag.SortBy as string ?? "featured";
    var minRating = ViewBag.MinRating as string ?? "";
    var priceRange = ViewBag.PriceRange as string ?? "";
    string DefaultBusinessImage = Url.Content("~/images/business-placeholder.jpg");
}

<div class="container-fluid search-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Ana Sayfa</a></li>
            <li class="breadcrumb-item active" aria-current="page">Alanya İşletmeleri</li>
        </ol>
    </nav>

    <!-- Header & Filters Form -->
    <form id="filtersForm" method="get" action="@Url.Action("Search", "Home")" class="mb-4">
        <div class="row mb-3 align-items-center">
            <div class="col-md-6 col-lg-8">
                <div>
                    <h1 class="display-6 fw-bold text-dark mb-0">Alanya İşletmeleri</h1>
                    <p class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Alanya bölgesindeki tüm işletmeler
                    </p>
                </div>
            </div>

            <!-- Sort Options -->
            <div class="col-md-6 col-lg-4 text-md-end mt-3 mt-md-0">
                <label class="form-label me-2 mb-0 d-inline-block">Sırala:</label>
                <select name="sortBy" id="sortBy" class="form-select d-inline-block" style="width: 220px;" data-auto-submit="true">
                    <option value="featured" selected="@(sortBy == "featured")">Öne çıkanlar</option>
                    <option value="rating" selected="@(sortBy == "rating")">En yüksek puan</option>
                    <option value="reviews" selected="@(sortBy == "reviews")">En çok yorum</option>
                </select>
            </div>
        </div>

        <div class="row">
            <!-- Left Sidebar - Filters -->
            <div class="col-lg-3 col-md-4 mb-4">
                <div class="card filter-card shadow-sm">
                    <div class="card-body">
                        <!-- Search Form -->
                        <div class="mb-4">
                            <label class="visually-hidden" for="queryInput">İşletme ara</label>
                            <div class="input-group">
                                <input type="search" id="queryInput" name="query" class="form-control" placeholder="İşletme ara..." value="@query">
                                <button class="btn btn-primary" type="submit" aria-label="Ara">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Category Filter -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-tags me-2"></i>
                                Kategoriler
                            </h6>
                            @if (categories.Any())
                            {
                                <div class="overflow-auto" style="max-height: 240px;">
                                    @for (int idx = 0; idx < categories.Count; idx++)
                                    {
                                        var cat = categories[idx];
                                        var safeId = $"cat_{idx}";
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" id="@safeId" name="category" value="@cat"
                                                   @(cat == category ? "checked" : "") data-auto-submit="true">
                                            <label class="form-check-label" for="@safeId">
                                                @cat
                                            </label>
                                        </div>
                                    }
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" id="cat_all" name="category" value=""
                                               @(string.IsNullOrEmpty(category) ? "checked" : "") data-auto-submit="true">
                                        <label class="form-check-label" for="cat_all">Tümü</label>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Rating Filter -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-star me-2"></i>
                                Minimum Puan
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="minRating" id="rating_any" value=""
                                       @(string.IsNullOrEmpty(minRating) ? "checked" : "") data-auto-submit="true">
                                <label class="form-check-label" for="rating_any">Tümü</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="minRating" id="rating3" value="3"
                                       @(minRating == "3" ? "checked" : "") data-auto-submit="true">
                                <label class="form-check-label" for="rating3">
                                    <span class="text-warning"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span> 3+ Yıldız
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="minRating" id="rating4" value="4"
                                       @(minRating == "4" ? "checked" : "") data-auto-submit="true">
                                <label class="form-check-label" for="rating4">
                                    <span class="text-warning"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span> 4+ Yıldız
                                </label>
                            </div>
                        </div>

                        <!-- Price Range Filter -->
                        <div class="mb-3">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-money-bill-wave me-2"></i>Fiyat Aralığı
                            </h6>
                            <select name="priceRange" class="form-select" data-auto-submit="true">
                                <option value="" selected="@(string.IsNullOrEmpty(priceRange))">Hepsi</option>
                                <option value="$" selected="@(priceRange == "$")">$</option>
                                <option value="$$" selected="@(priceRange == "$$")">$$</option>
                                <option value="$$$" selected="@(priceRange == "$$$")">$$$</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <a href="@Url.Action("Search", "Home")" class="btn btn-outline-secondary flex-fill">Filtreleri Temizle</a>
                            <button type="submit" class="btn btn-primary flex-fill d-md-none">Uygula</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content - Search Results -->
            <div class="col-lg-9 col-md-8">
                <div class="mb-3">
                    <h5 class="text-muted">@((Model?.Count() ?? 0).ToString()) sonuç bulundu</h5>
                </div>

                <div class="row g-3">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var business in Model)
                        {
                            var avg = business.AverageRating;
                            var rounded = (int)Math.Round(avg);
                            <div class="col-12">
                                <div class="card h-100 search-result-card shadow-sm overflow-hidden position-relative">
                                    <div class="row g-0">
                                        <!-- Business Image -->
                                        <div class="col-md-4">
                                            <div class="business-image-container h-100">
                                                <img src="@(string.IsNullOrEmpty(business.ImageUrl) ? DefaultBusinessImage : business.ImageUrl)"
                                                     onerror="this.src='@DefaultBusinessImage'"
                                                     class="img-fluid w-100 h-100 object-fit-cover"
                                                     alt="@business.Name" style="height: 250px; object-fit: cover;">
                                                @if (business.IsFeatured)
                                                {
                                                    <div class="position-absolute top-2 end-2 m-2">
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-star me-1"></i>Öne Çıkan
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <!-- Business Info -->
                                        <div class="col-md-8">
                                            <div class="card-body d-flex flex-column h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h4 class="card-title fw-bold mb-1 text-dark">@business.Name</h4>
                                                        <!-- Use Description instead of ShortDescription -->
                                                        @if (!string.IsNullOrEmpty(business.Description))
                                                        {
                                                            <div class="small text-muted">
                                                                @(business.Description.Length > 100 ? business.Description.Substring(0, 100) + "..." : business.Description)
                                                            </div>
                                                        }
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fw-bold text-warning fs-5">@business.AverageRating.ToString("F1")</div>
                                                        <div class="small text-muted">(@business.TotalReviews yorum)</div>
                                                    </div>
                                                </div>

                                                <!-- Rating Stars -->
                                                <div class="mb-2">
                                                    <div class="d-inline-flex align-items-center">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (i <= Math.Floor(avg))
                                                            {
                                                                <i class="fas fa-star text-warning me-1"></i>
                                                            }
                                                            else if (i == Math.Ceiling(avg) && avg - Math.Floor(avg) >= 0.5)
                                                            {
                                                                <i class="fas fa-star-half-alt text-warning me-1"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="far fa-star text-warning me-1"></i>
                                                            }
                                                        }
                                                    </div>
                                                </div>

                                                <!-- Category & Price -->
                                                <div class="mb-2">
                                                    <span class="badge bg-primary text-white me-2">
                                                        <i class="fas fa-tag me-1"></i>@(business.Category?.Name ?? "Kategori Yok")
                                                    </span>
                                                    @if (!string.IsNullOrEmpty(business.PriceRange))
                                                    {
                                                        <span class="badge bg-success ms-1">@business.PriceRange</span>
                                                    }
                                                </div>

                                                <!-- Description -->
                                                @if (!string.IsNullOrEmpty(business.Description))
                                                {
                                                    <p class="card-text text-muted mb-2">
                                                        @{
                                                            var desc = business.Description.Length > 160
                                                            ? business.Description.Substring(0, 160) + "..."
                                                            : business.Description;
                                                        }
                                                        @desc
                                                    </p>
                                                }

                                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                                    <div class="text-muted small">
                                                        @if (!string.IsNullOrEmpty(business.Address))
                                                        {
                                                            <div><i class="fas fa-map-marker-alt me-1 text-danger"></i> @business.Address</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(business.Phone))
                                                        {
                                                            <div><i class="fas fa-phone me-1 text-success"></i> @business.Phone</div>
                                                        }
                                                    </div>

                                                    <div>
                                                        <a href="@Url.Action("Details", "Businesses", new { id = business.Id })" class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-info-circle me-1"></i> Detayları Gör
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">Arama sonucu bulunamadı</h4>
                                <p class="text-muted">Farklı anahtar kelimeler deneyin veya filtreleri değiştirin.</p>
                                <a href="@Url.Action("Search", "Home")" class="btn btn-primary">
                                    <i class="fas fa-redo me-2"></i>Filtreleri Temizle
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .search-result-card {
        border: 1px solid #e9ecef;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        overflow: hidden;
        border-radius: 8px;
    }

        .search-result-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 14px 30px rgba(22, 28, 37, 0.12);
            border-color: rgba(13,110,253,0.12);
        }

    .business-image-container {
        position: relative;
        overflow: hidden;
        min-height: 250px;
    }

        .business-image-container img.object-fit-cover {
            transition: transform 0.35s ease;
            display: block;
        }

    .search-result-card:hover .business-image-container img.object-fit-cover {
        transform: scale(1.06);
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .filter-card {
        position: sticky;
        top: 20px;
    }

    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .breadcrumb a {
        text-decoration: none;
    }

    /* Fixed media query syntax */
    @@media (max-width: 767.98px) {
        .business-image-container {
            min-height: 180px;
        }
    }
</style>

@section Scripts {
    <script>
        (function () {
            // Auto-submit form when controls with data-auto-submit attribute change
            const form = document.getElementById('filtersForm');
            if (!form) return;

            form.querySelectorAll('[data-auto-submit="true"]').forEach(function (el) {
                el.addEventListener('change', function () {
                    form.requestSubmit();
                });
            });
        })();
    </script>
}