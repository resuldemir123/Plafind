@model IEnumerable<AlanyaBusinessGuide.Models.Business>
@{
    var businesses = Model?.ToList() ?? new List<AlanyaBusinessGuide.Models.Business>();
    var featuredBusinesses = businesses
        .Where(b => b.IsFeatured)
        .OrderByDescending(b => b.AverageRating)
        .Take(6)
        .ToList();

    var trendingBusinesses = businesses
        .OrderByDescending(b => b.TotalReviews)
        .ThenByDescending(b => b.AverageRating)
        .Take(6)
        .ToList();

    var allBusinessIds = new HashSet<int>(featuredBusinesses.Select(b => b.Id));
    foreach (var biz in trendingBusinesses)
    {
        allBusinessIds.Add(biz.Id);
    }

    var remainingBusinesses = businesses
        .Where(b => !allBusinessIds.Contains(b.Id))
        .OrderByDescending(b => b.AverageRating)
        .ToList();

    var categories = ViewBag.Categories as List<string> ?? new List<string>();
    var query = ViewBag.Query as string ?? string.Empty;
    var selectedCategory = ViewBag.Category as string ?? string.Empty;
    var minRating = ViewBag.MinRating as string ?? string.Empty;
    var priceRange = ViewBag.PriceRange as string ?? string.Empty;
    var sortBy = (ViewBag.SortBy as string ?? "featured").ToLower();
}

<section class="search-hero">
    <div class="hero-overlay">
        <div class="container">
            <p class="eyebrow">Alanya İşletmeleri</p>
            <h1>Aradığın deneyimi saniyeler içinde bul</h1>
            <p class="lead">Restoranlardan aktivitelere kadar yüzlerce işletme arasından filtrele, karşılaştır, hemen keşfet.</p>

            <form asp-action="Search" asp-controller="Home" method="get" class="search-bar row gx-2 gy-2">
                <div class="col-lg-4">
                    <div class="input-pill">
                        <i class="fas fa-search"></i>
                        <input type="text" name="query" value="@query" placeholder="İşletme adı, mutfak türü veya mahalle" />
                    </div>
                </div>
                <div class="col-lg-3">
                    <select name="category" class="input-pill">
                        <option value="" selected="@(string.IsNullOrEmpty(selectedCategory) ? "selected" : null)">Tüm kategoriler</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat" selected="@(cat == selectedCategory ? "selected" : null)">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-lg-2">
                    <select name="minRating" class="input-pill">
                        <option value="" selected="@(string.IsNullOrEmpty(minRating) ? "selected" : null)">Puan</option>
                        <option value="4.5" selected="@(minRating == "4.5" ? "selected" : null)">4.5+</option>
                        <option value="4" selected="@(minRating == "4" ? "selected" : null)">4.0+</option>
                        <option value="3.5" selected="@(minRating == "3.5" ? "selected" : null)">3.5+</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <select name="priceRange" class="input-pill">
                        <option value="" selected="@(string.IsNullOrEmpty(priceRange) ? "selected" : null)">Fiyat</option>
                        <option value="$" selected="@(priceRange == "$" ? "selected" : null)">$</option>
                        <option value="$$" selected="@(priceRange == "$$" ? "selected" : null)">$$</option>
                        <option value="$$$" selected="@(priceRange == "$$$" ? "selected" : null)">$$$</option>
                    </select>
                </div>
                <div class="col-lg-1 d-grid">
                    <button type="submit" class="btn btn-warning rounded-pill">Ara</button>
                </div>
            </form>

            <div class="filter-chips">
                <span class="chip @(string.IsNullOrEmpty(sortBy) || sortBy == "featured" ? "active" : string.Empty)" data-sort="featured">Öne çıkanlar</span>
                <span class="chip @(sortBy == "rating" ? "active" : string.Empty)" data-sort="rating">En yüksek puan</span>
                <span class="chip @(sortBy == "reviews" ? "active" : string.Empty)" data-sort="reviews">En çok yorum</span>
                <span class="chip @(sortBy == "distance" ? "active" : string.Empty)" data-sort="distance">Yakındakiler</span>
            </div>
        </div>
    </div>
</section>

<section class="search-sections py-5">
    <div class="container">
        @if (featuredBusinesses.Any())
        {
            <div class="section-header">
                <div>
                    <p class="eyebrow">Öne Çıkan İşletmeler</p>
                    <h2>Seçtiğimiz favoriler</h2>
                </div>
                <span class="badge rounded-pill bg-warning text-dark">@featuredBusinesses.Count</span>
            </div>
            <div class="featured-carousel">
                @foreach (var business in featuredBusinesses)
                {
                    <article class="business-card highlight">
                        <div class="card-cover" style="background-image:url('@(string.IsNullOrWhiteSpace(business.ImageUrl) ? Url.Content("~/images/190_alanya.jpg") : business.ImageUrl)');"></div>
                        <div class="card-body">
                            <div class="card-badge">
                                <i class="fas fa-crown me-1"></i>Öne Çıkan
                            </div>
                            <h3>@business.Name</h3>
                            <p>@(business.Description?.Length > 80 ? business.Description[..80] + "..." : business.Description ?? "Açıklama eklenmemiş.")</p>
                            <div class="card-meta">
                                <span><i class="fas fa-star text-warning"></i>@business.AverageRating.ToString("F1")</span>
                                <span><i class="fas fa-comment"></i>@business.TotalReviews yorum</span>
                                <span><i class="fas fa-tag"></i>@business.Category?.Name</span>
                            </div>
                            <a asp-controller="Businesses" asp-action="Details" asp-route-id="@business.Id" class="btn btn-light btn-sm rounded-pill">İncele</a>
                        </div>
                    </article>
                }
            </div>
        }

        @if (trendingBusinesses.Any())
        {
            <div class="section-header mt-5">
                <div>
                    <p class="eyebrow">Popüler Seçimler</p>
                    <h2>Topluluğun favorileri</h2>
                </div>
                <span class="badge rounded-pill bg-info text-dark">@trendingBusinesses.Count</span>
            </div>
            <div class="trending-grid">
                @foreach (var business in trendingBusinesses)
                {
                    <article class="business-card compact">
                        <div>
                            <h3>@business.Name</h3>
                            <p>@business.Category?.Name</p>
                        </div>
                        <div class="rating">
                            <strong>@business.AverageRating.ToString("F1")</strong>
                            <span>@business.TotalReviews yorum</span>
                        </div>
                        <a asp-controller="Businesses" asp-action="Details" asp-route-id="@business.Id" class="btn btn-outline-light btn-sm rounded-pill">Detay</a>
                    </article>
                }
            </div>
        }

        <div class="section-header mt-5">
            <div>
                <p class="eyebrow">Tüm Sonuçlar</p>
                <h2>Keşfedilecek diğer işletmeler</h2>
            </div>
            <span class="badge rounded-pill bg-secondary">@businesses.Count</span>
        </div>

        @if (businesses.Any())
        {
            <div class="results-grid">
                @foreach (var business in businesses)
                {
                    <article class="business-card basic">
                        <div class="card-cover" style="background-image:url('@(string.IsNullOrWhiteSpace(business.ImageUrl) ? Url.Content("~/images/190_alanya.jpg") : business.ImageUrl)');"></div>
                        <div class="card-body">
                            <div class="card-top">
                                <div>
                                    <h3>@business.Name</h3>
                                    <p class="muted">@business.Category?.Name ?? "Kategori yok"</p>
                                </div>
                                <div class="rating">
                                    <strong>@business.AverageRating.ToString("F1")</strong>
                                    <span>@business.TotalReviews yorum</span>
                                </div>
                            </div>
                            <p class="address">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                @(string.IsNullOrWhiteSpace(business.Address) ? "Adres bilgisi eklenmemiş" : business.Address)
                            </p>
                            <div class="card-actions">
                                @if (!string.IsNullOrEmpty(business.Phone))
                                {
                                    <a href="tel:@business.Phone" class="link">
                                        <i class="fas fa-phone"></i> Ara
                                    </a>
                                }
                                <a asp-controller="Businesses" asp-action="Details" asp-route-id="@business.Id" class="btn btn-warning btn-sm rounded-pill">Detay</a>
                            </div>
                        </div>
                    </article>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>Sonuç bulunamadı</h3>
                <p>Filtreleri gevşetmeyi veya farklı bir anahtar kelime denemeyi düşünün.</p>
            </div>
        }
    </div>
</section>

<style>
    .search-hero {
        background: radial-gradient(circle at top, rgba(255, 193, 7, 0.15), transparent 50%), #050c19;
        color: #f8f9fa;
        padding: 4rem 0 2rem;
    }

    .hero-overlay .eyebrow {
        text-transform: uppercase;
        letter-spacing: .25em;
        font-size: .85rem;
        color: rgba(255,255,255,.7);
    }

    .hero-overlay h1 {
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .hero-overlay .lead {
        color: rgba(255,255,255,.8);
        margin-bottom: 2rem;
        max-width: 600px;
    }

    .search-bar .input-pill {
        display: flex;
        align-items: center;
        gap: .5rem;
        background: rgba(255,255,255,.1);
        border-radius: 999px;
        padding: .75rem 1.2rem;
        border: 1px solid rgba(255,255,255,.2);
        color: #fff;
    }

    .search-bar input,
    .search-bar select {
        background: transparent;
        border: none;
        color: #fff;
        width: 100%;
        outline: none;
    }

    .search-bar option {
        color: #000;
    }

    .filter-chips {
        display: flex;
        gap: .75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }

    .filter-chips .chip {
        padding: .5rem 1rem;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.3);
        cursor: pointer;
        color: rgba(255,255,255,.8);
        transition: all .2s ease;
    }

    .filter-chips .chip.active,
    .filter-chips .chip:hover {
        background: #ffc107;
        color: #111;
        border-color: #ffc107;
    }

    .search-sections {
        background: linear-gradient(180deg, #050c19 0%, #0d1424 50%, #050c19 100%);
        color: #e5e7eb;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .section-header h2 {
        margin: 0;
        font-weight: 700;
    }

    .section-header .eyebrow {
        color: rgba(229,231,235,.6);
        margin-bottom: .35rem;
    }

    .featured-carousel {
        display: grid;
        gap: 1.2rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .business-card {
        background: rgba(13,18,32,.9);
        border-radius: 1.25rem;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,.05);
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 45px rgba(5,10,20,.6);
    }

    .business-card.highlight {
        min-height: 360px;
    }

    .business-card .card-cover {
        height: 150px;
        background-size: cover;
        background-position: center;
    }

    .business-card .card-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: .75rem;
    }

    .card-badge {
        align-self: flex-start;
        padding: .35rem .85rem;
        border-radius: 999px;
        background: rgba(255,193,7,.1);
        border: 1px solid rgba(255,193,7,.3);
        color: #ffc107;
        font-size: .85rem;
        font-weight: 600;
    }

    .card-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: .9rem;
        color: rgba(229,231,235,.7);
    }

    .card-meta span {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    .trending-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .business-card.compact {
        padding: 1rem 1.25rem;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
    }

    .business-card.compact h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .business-card.compact p {
        margin: 0;
        color: rgba(229,231,235,.6);
    }

    .business-card.compact .rating {
        text-align: right;
    }

    .results-grid {
        display: grid;
        gap: 1.2rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .business-card.basic .card-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .business-card.basic h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .business-card.basic .muted {
        color: rgba(229,231,235,.6);
        margin: 0;
    }

    .business-card.basic .address {
        margin: .75rem 0;
        color: rgba(229,231,235,.7);
    }

    .card-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .card-actions .link {
        color: #60a5fa;
        text-decoration: none;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        border-radius: 1.5rem;
        border: 1px dashed rgba(255,255,255,.2);
    }

    .empty-state i {
        font-size: 3rem;
        color: #ffc107;
        margin-bottom: 1rem;
    }

    @@media (max-width: 768px) {
        .search-bar {
            padding: 1rem 0;
        }

        .search-bar .input-pill {
            border-radius: .9rem;
        }

        .filter-chips {
            gap: .5rem;
        }
    }
</style>

<script>
    document.querySelectorAll('.filter-chips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const sort = chip.dataset.sort;
            const url = new URL(window.location.href);
            url.searchParams.set('sortBy', sort);
            window.location.href = url.toString();
        });
    });
</script>

