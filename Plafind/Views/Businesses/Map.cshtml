@model IEnumerable<Plafind.Models.Business>
@{
    ViewData["Title"] = "Harita - İşletmeler";
    var businesses = Model?.Where(b => b.IsActive && b.IsApproved).ToList() ?? new List<Plafind.Models.Business>();
}

<section class="map-shell">
    <div class="map-panel">
        <div id="businessMap" class="map-canvas" aria-label="İşletme haritası"></div>
        <div id="mapStatus" class="map-status d-none">
            <i class="fas fa-map-marker-alt"></i>
            <p>Henüz konumu belirtilmiş bir işletme bulunamadı.</p>
        </div>
    </div>
    <div class="ai-panel">
        <div class="ai-card">
                    <div class="ai-header d-flex align-items-center justify-content-between">
                        <div>
                            <p class="eyebrow mb-1">Gemini Destekli Asistan</p>
                            <h3 class="mb-0">Konuma göre öneri al</h3>
                        </div>
                        <button type="button" id="aiLocationBtn" class="btn btn-outline-warning btn-sm rounded-pill">
                            <i class="fas fa-location-arrow me-1"></i> Konumumu Kullan
                        </button>
                    </div>
                    <div id="aiLocationInfo" class="ai-location-info d-none">
                        <i class="fas fa-check-circle text-success me-1"></i> Konum bilgisi eklendi.
                    </div>
                    <div id="aiMessages" class="ai-messages">
                        <div class="ai-message assistant">
                            <p>Merhaba! Bulunduğun bölgeye göre restoran, otel veya aktivite önerileri sunabilirim. Bana ne aradığını söylemen yeterli.</p>
                        </div>
                    </div>
                    <form id="aiForm" class="ai-input">
                        <textarea id="aiPrompt" class="form-control" rows="2" placeholder="Örn: 'Konaklı'da çocukla gidilebilecek restoran önerir misin?"></textarea>
                        <div class="ai-actions">
                            <small id="aiStatus" class="text-muted">Gemini ile sohbet ediyorsun.</small>
                            <button type="submit" id="aiSendBtn" class="btn btn-warning rounded-pill">
                                <i class="fas fa-paper-plane me-1"></i> Gönder
                            </button>
                        </div>
                    </form>
        </div>
    </div>
</section>

<style>
    .map-shell {
        min-height: calc(100vh - 140px);
        background: radial-gradient(circle at top, rgba(255,193,7,0.08), transparent 50%), #040b19;
        color: #f8f9fa;
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
        gap: 1.25rem;
        padding: 1.5rem;
    }

    .map-panel,
    .ai-panel {
        position: relative;
        border-radius: 1.5rem;
        background: rgba(8,12,25,.7);
        border: 1px solid rgba(255,255,255,.08);
        box-shadow: 0 20px 50px rgba(4,6,15,.6);
    }

    .map-panel {
        overflow: hidden;
    }

    .map-canvas {
        width: 100%;
        height: 100%;
        min-height: 520px;
        border-radius: inherit;
    }

    .ai-panel {
        display: flex;
    }

    .map-status {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        background: rgba(5,10,20,.8);
        color: rgba(255,255,255,.8);
        text-align: center;
    }

    .map-status i {
        font-size: 2.5rem;
        color: #ffc107;
    }

    .ai-card {
        background: rgba(13,18,32,.95);
        border-radius: 1.5rem;
        border: 1px solid rgba(255,255,255,.08);
        padding: 1.25rem;
        box-shadow: 0 20px 45px rgba(5,10,20,.5);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .ai-messages {
        background: rgba(5,10,20,.6);
        border-radius: 1rem;
        padding: 1rem;
        max-height: 260px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: .75rem;
    }

    .ai-message {
        padding: .85rem 1rem;
        border-radius: 1rem;
        font-size: .95rem;
        line-height: 1.6;
    }

    .ai-message.assistant {
        background: rgba(255,193,7,.1);
        border: 1px solid rgba(255,193,7,.3);
        color: #fefce8;
    }

    .ai-message.user {
        background: rgba(96,165,250,.12);
        border: 1px solid rgba(96,165,250,.35);
        color: #dbeafe;
        align-self: flex-end;
    }

    .ai-input textarea {
        background: rgba(5,10,20,.6);
        border: 1px solid rgba(255,255,255,.1);
        color: #f8fafc;
        border-radius: 1rem;
    }

    .ai-input textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255,193,7,.3);
    }

    .ai-actions {
        margin-top: .5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .ai-location-info {
        font-size: .9rem;
        color: #86efac;
    }

    @@media (max-width: 992px) {
        .map-shell {
            grid-template-columns: 1fr;
        }

        .map-panel {
            min-height: 420px;
        }
    }

    @@media (max-width: 576px) {
        .map-shell {
            padding: 1rem;
        }
    }
</style>

@section Scripts {
    <script>
        const mapStatus = document.getElementById('mapStatus');
        const markers = {};
        const defaultCenter = { lat: 36.5437, lng: 31.9995 };
        let googleMap;
        let infoWindow;

        window.initBusinessMap = function () {
            if (!document.getElementById('businessMap')) {
                return;
            }

            googleMap = new google.maps.Map(document.getElementById('businessMap'), {
                zoom: 12,
                center: defaultCenter,
                mapId: 'DEMO_MAP_ID'
            });

            infoWindow = new google.maps.InfoWindow();
            loadBusinessMarkers();
        };

        function loadBusinessMarkers() {
            fetch('@Url.Action("Locations", "Businesses")')
                .then(response => response.json())
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        mapStatus?.classList.remove('d-none');
                        return;
                    }

                    const bounds = new google.maps.LatLngBounds();

                    data.forEach(item => {
                        if (!item.latitude || !item.longitude) {
                            return;
                        }
                        const lat = parseFloat(item.latitude);
                        const lng = parseFloat(item.longitude);
                        if (Number.isNaN(lat) || Number.isNaN(lng)) {
                            return;
                        }

                        const position = { lat, lng };
                        const marker = new google.maps.Marker({
                            position,
                            map: googleMap,
                            title: item.name ?? 'İşletme'
                        });

                        const popup = `
                            <div class="map-popup">
                                <strong>${item.name ?? 'İşletme'}</strong><br/>
                                ${(item.category ?? '')}
                                <div class="mt-2">
                                    <span><i class="fas fa-star text-warning"></i> ${(item.averageRating ?? 0).toFixed(1)}</span>
                                    <span class="ms-2"><i class="fas fa-comment text-info"></i> ${item.totalReviews ?? 0}</span>
                                </div>
                                <div class="mt-2">
                                    <a href="/Businesses/Details/${item.id}" class="btn btn-sm btn-warning rounded-pill">Detay</a>
                                </div>
                            </div>`;

                        marker.addListener('click', () => {
                            infoWindow.setContent(popup);
                            infoWindow.open(googleMap, marker);
                        });

                        markers[item.id] = marker;
                        bounds.extend(position);
                    });

                    if (!bounds.isEmpty()) {
                        googleMap.fitBounds(bounds);
                    } else {
                        mapStatus?.classList.remove('d-none');
                    }
                })
                .catch(() => mapStatus?.classList.remove('d-none'));
        }

            const aiForm = document.getElementById('aiForm');
            const aiPrompt = document.getElementById('aiPrompt');
            const aiMessages = document.getElementById('aiMessages');
            const aiStatus = document.getElementById('aiStatus');
            const aiSendBtn = document.getElementById('aiSendBtn');
            const aiLocationBtn = document.getElementById('aiLocationBtn');
            const aiLocationInfo = document.getElementById('aiLocationInfo');
            let lastLocation = null;
            let isSending = false;

            function appendMessage(role, text) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('ai-message', role);
                wrapper.innerHTML = `<p>${text}</p>`;
                aiMessages.appendChild(wrapper);
                aiMessages.scrollTop = aiMessages.scrollHeight;
            }

            function setStatus(message) {
                if (aiStatus) {
                    aiStatus.textContent = message;
                }
            }

            aiLocationBtn?.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    setStatus('Tarayıcınız konum paylaşımını desteklemiyor.');
                    return;
                }

                setStatus('Konum alınıyor...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        lastLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        aiLocationInfo?.classList.remove('d-none');
                        setStatus('Konum eklendi, sorunuzu yazabilirsiniz.');
                    },
                    () => setStatus('Konum izni reddedildi veya alınamadı.')
                );
            });

            aiForm?.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (isSending) return;

                const prompt = aiPrompt?.value.trim();
                if (!prompt) {
                    setStatus('Lütfen bir soru yazın.');
                    return;
                }

                appendMessage('user', prompt);
                aiPrompt.value = '';

                isSending = true;
                aiSendBtn.disabled = true;
                setStatus('Gemini yanıtı hazırlanıyor...');

                try {
                    const response = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt,
                            latitude: lastLocation?.latitude,
                            longitude: lastLocation?.longitude
                        })
                    });

                    if (!response.ok) {
                        throw new Error('İstek başarısız');
                    }

                    const data = await response.json();
                    appendMessage('assistant', data.response ?? 'Yanıt alınamadı.');
                    setStatus('Yeni sorular sorabilirsiniz.');
                } catch (error) {
                    appendMessage('assistant', 'Şu an cevap veremiyorum. Lütfen tekrar deneyin.');
                    setStatus('Bir sorun oluştu.');
                } finally {
                    isSending = false;
                    aiSendBtn.disabled = false;
                }
            });
    </script>
    @if (!string.IsNullOrEmpty(ViewBag.GoogleMapsApiKey as string))
    {
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=@ViewBag.GoogleMapsApiKey&callback=initBusinessMap"></script>
    }
    else
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var fallbackStatus = document.getElementById('mapStatus');
                if (fallbackStatus) {
                    fallbackStatus.classList.remove('d-none');
                    fallbackStatus.querySelector('p').textContent = 'Google Maps anahtarı bulunamadı.';
                }
            });
        </script>
    }
}

